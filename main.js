"use strict";var re=Object.create;var b=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var ae=Object.getPrototypeOf,ce=Object.prototype.hasOwnProperty;var le=(n,e,t)=>e in n?b(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var de=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of oe(e))!ce.call(n,o)&&o!==t&&b(n,o,{get:()=>e[o],enumerable:!(i=ie(e,o))||i.enumerable});return n};var ue=(n,e,t)=>(t=n!=null?re(ae(n)):{},de(e||!n||!n.__esModule?b(t,"default",{value:n,enumerable:!0}):t,n));var f=(n,e,t)=>le(n,typeof e!="symbol"?e+"":e,t);const p=require("electron"),I=require("node:path"),Ee=require("path"),Se=require("child_process"),_e=require("tty"),Te=require("util"),he=require("fs"),pe=require("net"),B=require("ws"),Q=require("node:child_process"),R=require("node:fs/promises"),M=require("node:os"),Y=require("node:fs");function fe(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var H={exports:{}},G={exports:{}},y={exports:{}},k,W;function ge(){if(W)return k;W=1;var n=1e3,e=n*60,t=e*60,i=t*24,o=i*365.25;k=function(s,a){a=a||{};var d=typeof s;if(d==="string"&&s.length>0)return l(s);if(d==="number"&&isNaN(s)===!1)return a.long?S(s):_(s);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(s))};function l(s){if(s=String(s),!(s.length>100)){var a=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(s);if(a){var d=parseFloat(a[1]),T=(a[2]||"ms").toLowerCase();switch(T){case"years":case"year":case"yrs":case"yr":case"y":return d*o;case"days":case"day":case"d":return d*i;case"hours":case"hour":case"hrs":case"hr":case"h":return d*t;case"minutes":case"minute":case"mins":case"min":case"m":return d*e;case"seconds":case"second":case"secs":case"sec":case"s":return d*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return d;default:return}}}}function _(s){return s>=i?Math.round(s/i)+"d":s>=t?Math.round(s/t)+"h":s>=e?Math.round(s/e)+"m":s>=n?Math.round(s/n)+"s":s+"ms"}function S(s){return u(s,i,"day")||u(s,t,"hour")||u(s,e,"minute")||u(s,n,"second")||s+" ms"}function u(s,a,d){if(!(s<a))return s<a*1.5?Math.floor(s/a)+" "+d:Math.ceil(s/a)+" "+d+"s"}return k}var q;function $(){return q||(q=1,function(n,e){e=n.exports=o.debug=o.default=o,e.coerce=u,e.disable=_,e.enable=l,e.enabled=S,e.humanize=ge(),e.names=[],e.skips=[],e.formatters={};var t;function i(s){var a=0,d;for(d in s)a=(a<<5)-a+s.charCodeAt(d),a|=0;return e.colors[Math.abs(a)%e.colors.length]}function o(s){function a(){if(a.enabled){var d=a,T=+new Date,E=T-(t||T);d.diff=E,d.prev=t,d.curr=T,t=T;for(var c=new Array(arguments.length),g=0;g<c.length;g++)c[g]=arguments[g];c[0]=e.coerce(c[0]),typeof c[0]!="string"&&c.unshift("%O");var h=0;c[0]=c[0].replace(/%([a-zA-Z%])/g,function(O,ne){if(O==="%%")return O;h++;var F=e.formatters[ne];if(typeof F=="function"){var se=c[h];O=F.call(d,se),c.splice(h,1),h--}return O}),e.formatArgs.call(d,c);var C=a.log||e.log||console.log.bind(console);C.apply(d,c)}}return a.namespace=s,a.enabled=e.enabled(s),a.useColors=e.useColors(),a.color=i(s),typeof e.init=="function"&&e.init(a),a}function l(s){e.save(s),e.names=[],e.skips=[];for(var a=(typeof s=="string"?s:"").split(/[\s,]+/),d=a.length,T=0;T<d;T++)a[T]&&(s=a[T].replace(/\*/g,".*?"),s[0]==="-"?e.skips.push(new RegExp("^"+s.substr(1)+"$")):e.names.push(new RegExp("^"+s+"$")))}function _(){e.enable("")}function S(s){var a,d;for(a=0,d=e.skips.length;a<d;a++)if(e.skips[a].test(s))return!1;for(a=0,d=e.names.length;a<d;a++)if(e.names[a].test(s))return!0;return!1}function u(s){return s instanceof Error?s.stack||s.message:s}}(y,y.exports)),y.exports}var j;function me(){return j||(j=1,function(n,e){e=n.exports=$(),e.log=o,e.formatArgs=i,e.save=l,e.load=_,e.useColors=t,e.storage=typeof chrome<"u"&&typeof chrome.storage<"u"?chrome.storage.local:S(),e.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"];function t(){return typeof window<"u"&&window.process&&window.process.type==="renderer"?!0:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}e.formatters.j=function(u){try{return JSON.stringify(u)}catch(s){return"[UnexpectedJSONParseError]: "+s.message}};function i(u){var s=this.useColors;if(u[0]=(s?"%c":"")+this.namespace+(s?" %c":" ")+u[0]+(s?"%c ":" ")+"+"+e.humanize(this.diff),!!s){var a="color: "+this.color;u.splice(1,0,a,"color: inherit");var d=0,T=0;u[0].replace(/%[a-zA-Z%]/g,function(E){E!=="%%"&&(d++,E==="%c"&&(T=d))}),u.splice(T,0,a)}}function o(){return typeof console=="object"&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function l(u){try{u==null?e.storage.removeItem("debug"):e.storage.debug=u}catch{}}function _(){var u;try{u=e.storage.debug}catch{}return!u&&typeof process<"u"&&"env"in process&&(u=process.env.DEBUG),u}e.enable(_());function S(){try{return window.localStorage}catch{}}}(G,G.exports)),G.exports}var D={exports:{}},z;function Ae(){return z||(z=1,function(n,e){var t=_e,i=Te;e=n.exports=$(),e.init=T,e.log=u,e.formatArgs=S,e.save=s,e.load=a,e.useColors=_,e.colors=[6,2,3,4,5,1],e.inspectOpts=Object.keys(process.env).filter(function(E){return/^debug_/i.test(E)}).reduce(function(E,c){var g=c.substring(6).toLowerCase().replace(/_([a-z])/g,function(C,O){return O.toUpperCase()}),h=process.env[c];return/^(yes|on|true|enabled)$/i.test(h)?h=!0:/^(no|off|false|disabled)$/i.test(h)?h=!1:h==="null"?h=null:h=Number(h),E[g]=h,E},{});var o=parseInt(process.env.DEBUG_FD,10)||2;o!==1&&o!==2&&i.deprecate(function(){},"except for stderr(2) and stdout(1), any other usage of DEBUG_FD is deprecated. Override debug.log if you want to use a different log function (https://git.io/debug_fd)")();var l=o===1?process.stdout:o===2?process.stderr:d(o);function _(){return"colors"in e.inspectOpts?!!e.inspectOpts.colors:t.isatty(o)}e.formatters.o=function(E){return this.inspectOpts.colors=this.useColors,i.inspect(E,this.inspectOpts).split(`
`).map(function(c){return c.trim()}).join(" ")},e.formatters.O=function(E){return this.inspectOpts.colors=this.useColors,i.inspect(E,this.inspectOpts)};function S(E){var c=this.namespace,g=this.useColors;if(g){var h=this.color,C="  \x1B[3"+h+";1m"+c+" \x1B[0m";E[0]=C+E[0].split(`
`).join(`
`+C),E.push("\x1B[3"+h+"m+"+e.humanize(this.diff)+"\x1B[0m")}else E[0]=new Date().toUTCString()+" "+c+" "+E[0]}function u(){return l.write(i.format.apply(i,arguments)+`
`)}function s(E){E==null?delete process.env.DEBUG:process.env.DEBUG=E}function a(){return process.env.DEBUG}function d(E){var c,g=process.binding("tty_wrap");switch(g.guessHandleType(E)){case"TTY":c=new t.WriteStream(E),c._type="tty",c._handle&&c._handle.unref&&c._handle.unref();break;case"FILE":var h=he;c=new h.SyncWriteStream(E,{autoClose:!1}),c._type="fs";break;case"PIPE":case"TCP":var C=pe;c=new C.Socket({fd:E,readable:!1,writable:!0}),c.readable=!1,c.read=null,c._type="pipe",c._handle&&c._handle.unref&&c._handle.unref();break;default:throw new Error("Implement me. Unknown stream file type!")}return c.fd=E,c._isStdio=!0,c}function T(E){E.inspectOpts={};for(var c=Object.keys(e.inspectOpts),g=0;g<c.length;g++)E.inspectOpts[c[g]]=e.inspectOpts[c[g]]}e.enable(a())}(D,D.exports)),D.exports}typeof process<"u"&&process.type==="renderer"?H.exports=me():H.exports=Ae();var Ie=H.exports,K=Ee,Ne=Se.spawn,ee=Ie("electron-squirrel-startup"),U=p.app,V=function(n,e){var t=K.resolve(K.dirname(process.execPath),"..","Update.exe");ee("Spawning `%s` with args `%s`",t,n),Ne(t,n,{detached:!0}).on("close",e)},Ce=function(){if(process.platform==="win32"){var n=process.argv[1];ee("processing squirrel command `%s`",n);var e=K.basename(process.execPath);if(n==="--squirrel-install"||n==="--squirrel-updated")return V(["--createShortcut="+e],U.quit),!0;if(n==="--squirrel-uninstall")return V(["--removeShortcut="+e],U.quit),!0;if(n==="--squirrel-obsolete")return U.quit(),!0}return!1},we=Ce();const Oe=fe(we),A={AGENT_PROMPT:"agent:prompt",AGENT_ABORT:"agent:abort",AGENT_NEW_SESSION:"agent:new-session",AGENT_EVENT:"agent:event",AGENT_STATUS:"agent:status",SESSION_RECOMPACT:"session:recompact",SESSION_DELETE:"session:delete",SESSION_DELETE_FOLDER:"session:delete-folder",SESSION_LIST:"session:list",SESSION_HISTORY:"session:history",SESSION_LIST_ALL:"session:list-all",SESSION_SWITCH:"session:switch",MODEL_LIST:"model:list",MODEL_SET:"model:set",MODEL_CURRENT:"model:current",MODEL_CYCLE:"model:cycle",THINKING_GET:"thinking:get",THINKING_SET:"thinking:set",THINKING_CYCLE:"thinking:cycle",SUBAGENT_SPAWN:"subagent:spawn",SUBAGENT_PROMPT:"subagent:prompt",SUBAGENT_ABORT:"subagent:abort",SUBAGENT_CLOSE:"subagent:close",SUBAGENT_LIST:"subagent:list",SUBAGENT_HISTORY:"subagent:history",SUBAGENT_EVENT:"subagent:event",SUBAGENT_MESSAGE:"subagent:message",SUBAGENT_BUS_HISTORY:"subagent:bus-history",COMMAND_LIST:"command:list",GIT_STATUS:"git:status",GIT_BRANCHES:"git:branches",GIT_CHECKOUT:"git:checkout",GIT_CHECKOUT_NEW:"git:checkout-new",GIT_STAGE:"git:stage",GIT_UNSTAGE:"git:unstage",GIT_STAGE_ALL:"git:stage-all",GIT_DISCARD:"git:discard",GIT_DIFF:"git:diff",GIT_CHANGED:"git:changed",APP_GET_CWD:"app:get-cwd",APP_SELECT_DIR:"app:select-dir",APP_OPEN_DIR:"app:open-dir",APP_GET_THEME:"app:get-theme",MEMORY_LIST:"memory:list",MEMORY_ADD:"memory:add",MEMORY_DELETE:"memory:delete",SKILL_LIST:"skill:list",SKILL_SAVE:"skill:save",SKILL_DELETE:"skill:delete",SKILL_RUN:"skill:run",SKILL_SUGGESTIONS:"skill:suggestions",SKILL_SUGGESTION_ADD:"skill:suggestion:add",SKILL_SUGGESTION_ACCEPT:"skill:suggestion:accept",SKILL_SUGGESTION_DISMISS:"skill:suggestion:dismiss",SCHEDULE_LIST:"schedule:list",SCHEDULE_SAVE:"schedule:save",SCHEDULE_DELETE:"schedule:delete",SCHEDULE_RUNS:"schedule:runs",SCHEDULE_TOGGLE:"schedule:toggle",SCHEDULE_EVENT:"schedule:event",AUDIT_LIST:"audit:list",AUDIT_ADD:"audit:add",TELEMETRY_ADD:"telemetry:add",MEMORY_CREATE_FROM_AGENT:"memory:create-from-agent",SKILL_CREATE_FROM_AGENT:"skill:create-from-agent",SKILL_SUGGEST_FROM_AGENT:"skill:suggest-from-agent",SCHEDULE_CREATE_FROM_AGENT:"schedule:create-from-agent",AGENT_REFRESH_PROACTIVE:"agent:refresh-proactive",WORKSPACE_GET_STATE:"workspace:get-state",WORKSPACE_LIST_RECENT:"workspace:list-recent",WORKSPACE_SET_PERSONA:"workspace:set-persona",WORKSPACE_UPDATE_CONFIG:"workspace:update-config",WORKSPACE_OPEN:"workspace:open",APP_GET_CONFIG:"app:get-config",APP_SET_DEFAULT_PERSONA:"app:set-default-persona",TASKS_LOAD:"tasks:load",TASKS_SAVE:"tasks:save",TASKS_CHANGED:"tasks:changed",PTY_CREATE:"pty:create",PTY_WRITE:"pty:write",PTY_RESIZE:"pty:resize",PTY_CLOSE:"pty:close",PTY_DATA:"pty:data",PTY_EXIT:"pty:exit"};function Le(){return I.join(M.homedir(),".tau","daemon")}function v(){return Le()}async function Ge(){const n=v();return await R.mkdir(n,{recursive:!0}),n}function x(){return I.join(v(),"pi-daemon.pid")}function Z(){return process.platform==="win32"?"\\\\.\\pipe\\pi-daemon":I.join(v(),"pi-daemon.sock")}const r={AGENT_PROMPT:"agent.prompt",AGENT_ABORT:"agent.abort",AGENT_NEW_SESSION:"agent.newSession",AGENT_STATUS:"agent.status",SESSION_RECOMPACT:"session.recompact",SESSION_DELETE:"session.delete",SESSION_DELETE_FOLDER:"session.deleteFolder",SESSION_LIST:"session.list",SESSION_HISTORY:"session.history",SESSION_LIST_ALL:"session.listAll",SESSION_SWITCH:"session.switch",MODEL_LIST:"model.list",MODEL_SET:"model.set",MODEL_CURRENT:"model.current",MODEL_CYCLE:"model.cycle",THINKING_GET:"thinking.get",THINKING_SET:"thinking.set",THINKING_CYCLE:"thinking.cycle",SUBAGENT_SPAWN:"subagent.spawn",SUBAGENT_PROMPT:"subagent.prompt",SUBAGENT_ABORT:"subagent.abort",SUBAGENT_CLOSE:"subagent.close",SUBAGENT_LIST:"subagent.list",SUBAGENT_HISTORY:"subagent.history",SUBAGENT_MESSAGE:"subagent.message",SUBAGENT_BUS_HISTORY:"subagent.busHistory",COMMAND_LIST:"command.list",GIT_STATUS:"git.status",GIT_BRANCHES:"git.branches",GIT_CHECKOUT:"git.checkout",GIT_CHECKOUT_NEW:"git.checkoutNew",GIT_STAGE:"git.stage",GIT_UNSTAGE:"git.unstage",GIT_STAGE_ALL:"git.stageAll",GIT_DISCARD:"git.discard",GIT_DIFF:"git.diff",APP_GET_CWD:"app.getCwd",APP_OPEN_DIR:"app.openDir",MEMORY_LIST:"memory.list",MEMORY_ADD:"memory.add",MEMORY_DELETE:"memory.delete",SKILL_LIST:"skill.list",SKILL_SAVE:"skill.save",SKILL_DELETE:"skill.delete",SKILL_RUN:"skill.run",SKILL_SUGGESTIONS:"skill.suggestions",SKILL_SUGGESTION_ADD:"skill.suggestion.add",SKILL_SUGGESTION_ACCEPT:"skill.suggestion.accept",SKILL_SUGGESTION_DISMISS:"skill.suggestion.dismiss",SCHEDULE_LIST:"schedule.list",SCHEDULE_SAVE:"schedule.save",SCHEDULE_DELETE:"schedule.delete",SCHEDULE_RUNS:"schedule.runs",SCHEDULE_TOGGLE:"schedule.toggle",AUDIT_LIST:"audit.list",AUDIT_ADD:"audit.add",TELEMETRY_ADD:"telemetry.add",MEMORY_CREATE_FROM_AGENT:"memory.createFromAgent",SKILL_CREATE_FROM_AGENT:"skill.createFromAgent",SKILL_SUGGEST_FROM_AGENT:"skill.suggestFromAgent",SCHEDULE_CREATE_FROM_AGENT:"schedule.createFromAgent",AGENT_REFRESH_PROACTIVE:"agent.refreshProactive",WORKSPACE_GET_STATE:"workspace.getState",WORKSPACE_LIST_RECENT:"workspace.listRecent",WORKSPACE_SET_PERSONA:"workspace.setPersona",WORKSPACE_UPDATE_CONFIG:"workspace.updateConfig",WORKSPACE_OPEN:"workspace.open",APP_GET_CONFIG:"app.getConfig",APP_SET_DEFAULT_PERSONA:"app.setDefaultPersona",TASKS_LOAD:"tasks.load",TASKS_SAVE:"tasks.save"},L={AGENT_EVENT:"daemon.agent.event",SUBAGENT_EVENT:"daemon.subagent.event",GIT_CHANGED:"daemon.git.changed",TASKS_CHANGED:"daemon.tasks.changed",SCHEDULE_EVENT:"daemon.schedule.event"},ye={"agent:prompt":r.AGENT_PROMPT,"agent:abort":r.AGENT_ABORT,"agent:new-session":r.AGENT_NEW_SESSION,"agent:status":r.AGENT_STATUS,"session:recompact":r.SESSION_RECOMPACT,"session:delete":r.SESSION_DELETE,"session:delete-folder":r.SESSION_DELETE_FOLDER,"session:list":r.SESSION_LIST,"session:history":r.SESSION_HISTORY,"session:list-all":r.SESSION_LIST_ALL,"session:switch":r.SESSION_SWITCH,"model:list":r.MODEL_LIST,"model:set":r.MODEL_SET,"model:current":r.MODEL_CURRENT,"model:cycle":r.MODEL_CYCLE,"thinking:get":r.THINKING_GET,"thinking:set":r.THINKING_SET,"thinking:cycle":r.THINKING_CYCLE,"subagent:spawn":r.SUBAGENT_SPAWN,"subagent:prompt":r.SUBAGENT_PROMPT,"subagent:abort":r.SUBAGENT_ABORT,"subagent:close":r.SUBAGENT_CLOSE,"subagent:list":r.SUBAGENT_LIST,"subagent:history":r.SUBAGENT_HISTORY,"subagent:message":r.SUBAGENT_MESSAGE,"subagent:bus-history":r.SUBAGENT_BUS_HISTORY,"command:list":r.COMMAND_LIST,"git:status":r.GIT_STATUS,"git:branches":r.GIT_BRANCHES,"git:checkout":r.GIT_CHECKOUT,"git:checkout-new":r.GIT_CHECKOUT_NEW,"git:stage":r.GIT_STAGE,"git:unstage":r.GIT_UNSTAGE,"git:stage-all":r.GIT_STAGE_ALL,"git:discard":r.GIT_DISCARD,"git:diff":r.GIT_DIFF,"app:get-cwd":r.APP_GET_CWD,"app:open-dir":r.APP_OPEN_DIR,"memory:list":r.MEMORY_LIST,"memory:add":r.MEMORY_ADD,"memory:delete":r.MEMORY_DELETE,"skill:list":r.SKILL_LIST,"skill:save":r.SKILL_SAVE,"skill:delete":r.SKILL_DELETE,"skill:run":r.SKILL_RUN,"skill:suggestions":r.SKILL_SUGGESTIONS,"skill:suggestion:add":r.SKILL_SUGGESTION_ADD,"skill:suggestion:accept":r.SKILL_SUGGESTION_ACCEPT,"skill:suggestion:dismiss":r.SKILL_SUGGESTION_DISMISS,"schedule:list":r.SCHEDULE_LIST,"schedule:save":r.SCHEDULE_SAVE,"schedule:delete":r.SCHEDULE_DELETE,"schedule:runs":r.SCHEDULE_RUNS,"schedule:toggle":r.SCHEDULE_TOGGLE,"audit:list":r.AUDIT_LIST,"audit:add":r.AUDIT_ADD,"telemetry:add":r.TELEMETRY_ADD,"memory:create-from-agent":r.MEMORY_CREATE_FROM_AGENT,"skill:create-from-agent":r.SKILL_CREATE_FROM_AGENT,"skill:suggest-from-agent":r.SKILL_SUGGEST_FROM_AGENT,"schedule:create-from-agent":r.SCHEDULE_CREATE_FROM_AGENT,"agent:refresh-proactive":r.AGENT_REFRESH_PROACTIVE,"workspace:get-state":r.WORKSPACE_GET_STATE,"workspace:list-recent":r.WORKSPACE_LIST_RECENT,"workspace:set-persona":r.WORKSPACE_SET_PERSONA,"workspace:update-config":r.WORKSPACE_UPDATE_CONFIG,"workspace:open":r.WORKSPACE_OPEN,"app:get-config":r.APP_GET_CONFIG,"app:set-default-persona":r.APP_SET_DEFAULT_PERSONA,"tasks:load":r.TASKS_LOAD,"tasks:save":r.TASKS_SAVE};function De(n){return ye[n]}const Re={[L.AGENT_EVENT]:"agent:event",[L.SUBAGENT_EVENT]:"subagent:event",[L.GIT_CHANGED]:"git:changed",[L.TASKS_CHANGED]:"tasks:changed",[L.SCHEDULE_EVENT]:"schedule:event"};function Pe(n){return Re[n]}const ve=new Set(["agent:event","subagent:event","git:changed","tasks:changed","schedule:event","app:get-theme","pty:create","pty:write","pty:resize","pty:close","pty:data","pty:exit"]);function be(n){return!ve.has(n)}const ke=3e4,J=15e3,X=3,Ue=1e3,Me=1e4;class He{constructor(){f(this,"ws",null);f(this,"nextId",1);f(this,"pending",new Map);f(this,"notificationHandlers",new Map);f(this,"lastHeartbeat",0);f(this,"heartbeatCheckTimer",null);f(this,"reconnectAttempt",0);f(this,"reconnectTimer",null);f(this,"_connected",!1);f(this,"_onDisconnect",null)}get connected(){return this._connected}set onDisconnect(e){this._onDisconnect=e}async ensureRunning(){if(await this.tryConnect())return;await this.spawnDaemon();const t=Z();for(let i=0;i<20;i++){await Fe(500);try{if(await R.access(t),await this.tryConnect())return}catch{}}throw new Error("Daemon failed to start within 10 seconds")}async tryConnect(){const e=await this.readPidFile();if(!e)return!1;if(!Ke(e.pid))return await R.unlink(x()).catch(()=>{}),!1;try{return await this.connect(e.socketPath),!0}catch{return!1}}connect(e){return new Promise((t,i)=>{const o=process.platform==="win32"?`ws+unix:${e}`:`ws+unix://${e}`,l=new B.WebSocket(o),_=setTimeout(()=>{l.close(),i(new Error("Connection timeout"))},5e3);l.on("open",()=>{clearTimeout(_),this.ws=l,this._connected=!0,this.reconnectAttempt=0,this.lastHeartbeat=Date.now(),this.startHeartbeatCheck(),console.log("[daemon-client] Connected to daemon"),t()}),l.on("message",S=>{this.handleMessage(S.toString("utf-8"))}),l.on("close",()=>{clearTimeout(_),this.handleDisconnect()}),l.on("error",S=>{clearTimeout(_),this._connected||i(S)})})}async spawnDaemon(){await Ge();const e=Z(),t=!process.resourcesPath,i=I.resolve(__dirname,"..");let o,l;t?(o=process.platform==="win32"?"npx.cmd":"npx",l=["tsx",I.join(i,"src","daemon","index.ts"),"--socket-path",e]):(o="node",l=[I.join(i,"daemon","index.js"),"--socket-path",e]),console.log(`[daemon-client] Spawning daemon: ${o} ${l.join(" ")}`);const _=I.join(v(),"pi-daemon.log"),{openSync:S}=await import("node:fs"),u=S(_,"a"),s=Q.spawn(o,l,{detached:!0,stdio:["ignore",u,u],cwd:process.cwd(),env:{...process.env}});s.unref(),console.log(`[daemon-client] Daemon spawned (pid: ${s.pid}), log: ${_}`)}disconnect(){this.stopHeartbeatCheck(),this.clearReconnectTimer(),this.ws&&(this.ws.close(1e3,"Client disconnecting"),this.ws=null),this._connected=!1;for(const[e,t]of this.pending)clearTimeout(t.timer),t.reject(new Error("Client disconnected"));this.pending.clear()}call(e,t){return new Promise((i,o)=>{if(!this.ws||this.ws.readyState!==B.WebSocket.OPEN){o(new Error("Not connected to daemon"));return}const l=this.nextId++,_={jsonrpc:"2.0",id:l,method:e,params:t},S=setTimeout(()=>{this.pending.delete(l),o(new Error(`RPC timeout: ${e}`))},ke);this.pending.set(l,{resolve:i,reject:o,timer:S}),this.ws.send(JSON.stringify(_))})}async callIpc(e,...t){const i=De(e);if(!i)throw new Error(`No RPC method for IPC channel: ${e}`);return this.call(i,t.length>0?t:void 0)}onNotification(e,t){let i=this.notificationHandlers.get(e);return i||(i=[],this.notificationHandlers.set(e,i)),i.push(t),()=>{const o=this.notificationHandlers.get(e);if(o){const l=o.indexOf(t);l>=0&&o.splice(l,1)}}}handleMessage(e){let t;try{t=JSON.parse(e)}catch{return}if(!(!t||t.jsonrpc!=="2.0")){if(t.id!=null&&(t.result!==void 0||t.error!==void 0)){const i=this.pending.get(t.id);i&&(this.pending.delete(t.id),clearTimeout(i.timer),t.error?i.reject(new Error(t.error.message||"RPC error")):i.resolve(t.result));return}if(t.method){t.method==="daemon.heartbeat"&&(this.lastHeartbeat=Date.now());const i=this.notificationHandlers.get(t.method);if(i)for(const o of i)try{o(t.params)}catch(l){console.error(`[daemon-client] Notification handler error for ${t.method}:`,l)}}}}startHeartbeatCheck(){this.stopHeartbeatCheck(),this.heartbeatCheckTimer=setInterval(()=>{Date.now()-this.lastHeartbeat>J&&(console.warn("[daemon-client] Heartbeat stale — daemon may be dead"),this.handleDisconnect())},J)}stopHeartbeatCheck(){this.heartbeatCheckTimer&&(clearInterval(this.heartbeatCheckTimer),this.heartbeatCheckTimer=null)}handleDisconnect(){var e;if(this._connected){this._connected=!1,this.ws=null,this.stopHeartbeatCheck(),console.warn("[daemon-client] Disconnected from daemon");for(const[,t]of this.pending)clearTimeout(t.timer),t.reject(new Error("Connection lost"));this.pending.clear(),(e=this._onDisconnect)==null||e.call(this),this.scheduleReconnect()}}scheduleReconnect(){if(this.reconnectAttempt>=X){console.error("[daemon-client] Max reconnect attempts reached — respawning daemon"),this.reconnectAttempt=0,this.ensureRunning().catch(t=>{console.error("[daemon-client] Failed to respawn daemon:",t)});return}const e=Math.min(Ue*Math.pow(2,this.reconnectAttempt),Me);this.reconnectAttempt++,console.log(`[daemon-client] Reconnecting in ${e}ms (attempt ${this.reconnectAttempt}/${X})`),this.reconnectTimer=setTimeout(async()=>{try{await this.tryConnect()||this.scheduleReconnect()}catch{this.scheduleReconnect()}},e)}clearReconnectTimer(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}async readPidFile(){try{const e=await R.readFile(x(),"utf-8");return JSON.parse(e)}catch{return null}}}function Ke(n){try{return process.kill(n,0),!0}catch{return!1}}function Fe(n){return new Promise(e=>setTimeout(e,n))}function Be(n,e,t,i){for(const l of Object.values(i))be(l)&&l!=="app:select-dir"&&l!=="app:get-theme"&&e.handle(l,async(_,...S)=>n.callIpc(l,...S));const o=["daemon.agent.event","daemon.subagent.event","daemon.git.changed","daemon.tasks.changed","daemon.schedule.event"];for(const l of o){const _=Pe(l);_&&n.onNotification(l,S=>{const u=t();if(u&&!u.isDestroyed()){const s=S&&Array.isArray(S.data)?S.data:S;u.webContents.send(_,s)}})}}const Ye=`
import pty, os, sys, select, signal, struct, fcntl, termios, json

shell = sys.argv[1] if len(sys.argv) > 1 else os.environ.get('SHELL', '/bin/zsh')
cwd = sys.argv[2] if len(sys.argv) > 2 else os.getcwd()
cols = int(sys.argv[3]) if len(sys.argv) > 3 else 80
rows = int(sys.argv[4]) if len(sys.argv) > 4 else 24

pid, fd = pty.openpty()

# Set initial terminal size
winsize = struct.pack('HHHH', rows, cols, 0, 0)
fcntl.ioctl(fd, termios.TIOCSWINSZ, winsize)

child = os.fork()
if child == 0:
    os.setsid()
    # Slave side
    slave_fd = os.dup(fd)
    os.close(pid)
    os.close(fd)
    os.dup2(slave_fd, 0)
    os.dup2(slave_fd, 1)
    os.dup2(slave_fd, 2)
    if slave_fd > 2:
        os.close(slave_fd)
    os.chdir(cwd)
    os.execvp(shell, [shell, '-l'])

os.close(fd)

# Handle SIGWINCH (resize) by reading from stdin
def handle_resize(signum, frame):
    pass

signal.signal(signal.SIGWINCH, handle_resize)
sys.stdout.buffer.write(b'\\x00READY\\n')
sys.stdout.buffer.flush()

try:
    while True:
        r, _, _ = select.select([pid, 0], [], [], 0.1)
        if pid in r:
            try:
                data = os.read(pid, 16384)
                if not data:
                    break
                sys.stdout.buffer.write(data)
                sys.stdout.buffer.flush()
            except OSError:
                break
        if 0 in r:
            try:
                data = os.read(0, 16384)
                if not data:
                    break
                # Check for resize escape: \\x00RESIZE:cols:rows\\n
                if data.startswith(b'\\x00RESIZE:'):
                    try:
                        parts = data.strip().decode().split(':')
                        c, r = int(parts[1]), int(parts[2])
                        winsize = struct.pack('HHHH', r, c, 0, 0)
                        fcntl.ioctl(pid, termios.TIOCSWINSZ, winsize)
                        os.kill(child, signal.SIGWINCH)
                    except:
                        pass
                else:
                    os.write(pid, data)
            except OSError:
                break
except KeyboardInterrupt:
    pass
finally:
    try:
        os.kill(child, signal.SIGHUP)
        os.waitpid(child, 0)
    except:
        pass
`;class We{constructor(e,t){f(this,"instances",new Map);f(this,"nextId",1);f(this,"onData");f(this,"onExit");f(this,"scriptPath",null);this.onData=e,this.onExit=t}getScriptPath(){if(this.scriptPath)return this.scriptPath;const e=M.tmpdir();return this.scriptPath=I.join(e,"pi-pty-bridge.py"),Y.writeFileSync(this.scriptPath,Ye,"utf-8"),this.scriptPath}create(e,t=80,i=24){var s,a;const o=`pty-${this.nextId++}`,l=process.env.SHELL||(M.platform()==="win32"?"powershell.exe":"/bin/zsh"),_=this.getScriptPath(),S=Q.spawn("python3",[_,l,e,String(t),String(i)],{stdio:["pipe","pipe","pipe"],cwd:e,env:{...process.env,TERM:"xterm-256color",COLUMNS:String(t),LINES:String(i)}});let u=!1;return(s=S.stdout)==null||s.on("data",d=>{const T=d.toString("utf-8");if(!u){const E=T.indexOf(`\0READY
`);if(E>=0){u=!0;const c=T.slice(E+7);c.length>0&&this.onData(o,c);return}}this.onData(o,T)}),(a=S.stderr)==null||a.on("data",d=>{this.onData(o,d.toString("utf-8"))}),S.on("close",d=>{this.instances.delete(o),this.onExit(o,d??0)}),S.on("error",d=>{console.error(`[pty-manager] Error for ${o}:`,d.message),this.instances.delete(o),this.onExit(o,1)}),this.instances.set(o,{id:o,process:S}),o}write(e,t){var o;const i=this.instances.get(e);(o=i==null?void 0:i.process.stdin)!=null&&o.writable&&i.process.stdin.write(t)}resize(e,t,i){var l;const o=this.instances.get(e);(l=o==null?void 0:o.process.stdin)!=null&&l.writable&&o.process.stdin.write(`\0RESIZE:${t}:${i}
`)}close(e){const t=this.instances.get(e);if(t){try{t.process.kill("SIGHUP")}catch{}this.instances.delete(e)}}closeAll(){for(const[e]of this.instances)this.close(e)}dispose(){if(this.closeAll(),this.scriptPath)try{Y.unlinkSync(this.scriptPath)}catch{}}}Oe&&p.app.quit();let m=null;const w=new He;let N=null;const te=()=>{m=new p.BrowserWindow({width:1200,height:750,minWidth:600,minHeight:400,titleBarStyle:"hiddenInset",trafficLightPosition:{x:15,y:15},vibrancy:"under-window",backgroundColor:"#00000000",webPreferences:{preload:I.join(__dirname,"preload.js"),contextIsolation:!0,nodeIntegration:!1}}),m.loadFile(I.join(__dirname,"../renderer/main_window/index.html")),m.webContents.openDevTools({mode:"detach"}),m.on("closed",()=>{m=null})};function P(n,e){m==null||m.webContents.send(n,e)}p.ipcMain.handle(A.APP_SELECT_DIR,async()=>{if(!m)return null;const n=await p.dialog.showOpenDialog(m,{properties:["openDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});p.ipcMain.handle(A.APP_GET_THEME,()=>p.nativeTheme.shouldUseDarkColors?"dark":"light");p.nativeTheme.on("updated",()=>{P(A.APP_GET_THEME,p.nativeTheme.shouldUseDarkColors?"dark":"light")});function qe(){N=new We((n,e)=>P(A.PTY_DATA,{id:n,data:e}),(n,e)=>P(A.PTY_EXIT,{id:n,exitCode:e})),p.ipcMain.handle(A.PTY_CREATE,(n,e,t,i)=>N.create(e,t,i)),p.ipcMain.handle(A.PTY_WRITE,(n,e,t)=>{N.write(e,t)}),p.ipcMain.handle(A.PTY_RESIZE,(n,e,t,i)=>{N.resize(e,t,i)}),p.ipcMain.handle(A.PTY_CLOSE,(n,e)=>{N.close(e)})}p.app.on("ready",async()=>{te(),qe();try{await w.ensureRunning(),console.log("[main] Connected to pi-daemon"),Be(w,p.ipcMain,()=>m,A)}catch(n){console.error("[main] Failed to connect to daemon:",n)}w.onNotification("daemon.heartbeat",n=>{P("daemon:heartbeat",n)}),w.onDisconnect=()=>{console.warn("[main] Lost connection to daemon — reconnecting...")}});p.app.on("window-all-closed",()=>{N==null||N.dispose(),N=null,w.disconnect(),process.platform!=="darwin"&&p.app.quit()});p.app.on("activate",()=>{p.BrowserWindow.getAllWindows().length===0&&(te(),w.connected||w.ensureRunning().catch(n=>{console.error("[main] Failed to reconnect to daemon:",n)}))});
